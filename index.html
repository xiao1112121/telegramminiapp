<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tr·ª£ l√Ω k√™nh</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f2f2f2;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      justify-content: space-between;
    }

    .header {
      padding: 16px;
      font-size: 18px;
      background: #ffffff;
      border-bottom: 1px solid #ccc;
    }

    main {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .add-section {
      text-align: center;
      margin-bottom: 20px;
    }

    .buttons-list {
      margin-top: 20px;
    }

    .button-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .button-info {
      flex: 1;
    }

    .button-label {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .button-url {
      font-size: 12px;
      color: #666;
      word-break: break-all;
    }

    .button-actions {
      display: flex;
      gap: 8px;
    }

    footer {
      padding: 10px;
      background: #ffffff;
      border-top: 1px solid #ccc;
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
    }

    .btn-add {
      background-color: #e3f2fd;
      color: #007aff;
    }

    .btn-done {
      width: 100%;
      background-color: #28a745;
      color: white;
    }

    .btn-edit {
      background-color: #ffc107;
      color: #333;
      font-size: 12px;
      padding: 4px 8px;
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
      font-size: 12px;
      padding: 4px 8px;
    }

    .popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .popup.hidden {
      display: none;
    }

    .popup-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 380px;
      position: relative;
    }

    .popup-close {
      position: absolute;
      right: 10px;
      top: 10px;
      cursor: pointer;
      font-size: 18px;
    }

    .popup-content h3 {
      margin-top: 0;
    }

    .popup-content label {
      display: block;
      margin-top: 10px;
      font-weight: 500;
    }

    .popup-content input,
    .popup-content select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .popup-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .btn-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn-success {
      background-color: #28a745;
      color: white;
    }

    .empty-state {
      text-align: center;
      color: #666;
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h2>Tr·ª£ l√Ω t·∫°o n√∫t</h2>
    </header>

    <main>
      <div class="add-section">
        <button id="btnAdd" class="btn btn-add">‚ûï Th√™m n√∫t</button>
      </div>

      <div class="buttons-list" id="buttonsList">
        <div class="empty-state" id="emptyState">
          Ch∆∞a c√≥ n√∫t n√†o. Nh·∫•n "Th√™m n√∫t" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
        </div>
      </div>
    </main>

    <footer>
      <button id="btnDone" class="btn btn-done">‚úÖ Ho√†n t·∫•t (<span id="buttonCount">0</span>)</button>
    </footer>
  </div>

  <div id="popup" class="popup hidden">
    <div class="popup-content">
      <h3 id="popupTitle">Th√™m n√∫t m·ªõi</h3>
      <span id="popupClose" class="popup-close">‚úñ</span>

      <label for="actionType">Lo·∫°i h√†nh ƒë·ªông</label>
      <select id="actionType">
        <option value="url">üîó Li√™n k·∫øt</option>
        <option value="url">üì§ M·ªü trang web</option>
        <option value="url">üí¨ K√™nh Telegram</option>
        <option value="url">ü§ñ Bot Telegram</option>
      </select>

      <label for="btnLabel">T√™n n√∫t</label>
      <input type="text" id="btnLabel" placeholder="V√≠ d·ª•: Tham gia k√™nh" />

      <label for="btnValue">Li√™n k·∫øt</label>
      <input type="text" id="btnValue" placeholder="https://t.me/example ho·∫∑c https://website.com" />

      <div class="popup-actions">
        <button class="btn btn-danger" id="btnDelete" style="display: none;">üóëÔ∏è X√≥a</button>
        <button class="btn btn-success" id="btnSave">‚úÖ L∆∞u</button>
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // Kh·ªüi t·∫°o Telegram WebApp
    let tg = window.Telegram.WebApp;
    tg.expand();

    // D·ªØ li·ªáu n√∫t
    let buttons = [];
    let editingIndex = -1;

    // DOM elements
    const btnAdd = document.getElementById("btnAdd");
    const btnDone = document.getElementById("btnDone");
    const popup = document.getElementById("popup");
    const popupClose = document.getElementById("popupClose");
    const btnSave = document.getElementById("btnSave");
    const btnDelete = document.getElementById("btnDelete");
    const buttonsList = document.getElementById("buttonsList");
    const emptyState = document.getElementById("emptyState");
    const buttonCount = document.getElementById("buttonCount");
    const popupTitle = document.getElementById("popupTitle");

    // Form elements
    const actionType = document.getElementById("actionType");
    const btnLabel = document.getElementById("btnLabel");
    const btnValue = document.getElementById("btnValue");

    // Event Listeners
    btnAdd.onclick = () => openPopup();
    popupClose.onclick = () => closePopup();
    btnSave.onclick = () => saveButton();
    btnDelete.onclick = () => deleteButton();
    btnDone.onclick = () => sendToBot();

    // ƒê√≥ng popup khi click b√™n ngo√†i
    popup.onclick = (e) => {
      if (e.target === popup) closePopup();
    };

    function openPopup(index = -1) {
      editingIndex = index;
      
      if (index >= 0) {
        // Ch·ªânh s·ª≠a n√∫t existing
        popupTitle.textContent = "Ch·ªânh s·ª≠a n√∫t";
        btnLabel.value = buttons[index].title;
        btnValue.value = buttons[index].link;
        btnDelete.style.display = "block";
      } else {
        // Th√™m n√∫t m·ªõi
        popupTitle.textContent = "Th√™m n√∫t m·ªõi";
        btnLabel.value = "";
        btnValue.value = "";
        btnDelete.style.display = "none";
      }
      
      popup.classList.remove("hidden");
      btnLabel.focus();
    }

    function closePopup() {
      popup.classList.add("hidden");
      editingIndex = -1;
    }

    function saveButton() {
      const title = btnLabel.value.trim();
      const link = btnValue.value.trim();

      if (!title) {
        alert("Vui l√≤ng nh·∫≠p t√™n n√∫t");
        btnLabel.focus();
        return;
      }

      if (!link) {
        alert("Vui l√≤ng nh·∫≠p li√™n k·∫øt");
        btnValue.focus();
        return;
      }

      // Validate URL
      if (!isValidUrl(link)) {
        alert("Li√™n k·∫øt kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p URL ƒë·∫ßy ƒë·ªß (b·∫Øt ƒë·∫ßu v·ªõi http:// ho·∫∑c https://)");
        btnValue.focus();
        return;
      }

      const buttonData = {
        type: actionType.value,
        title: title,
        link: link
      };

      if (editingIndex >= 0) {
        // C·∫≠p nh·∫≠t n√∫t existing
        buttons[editingIndex] = buttonData;
      } else {
        // Th√™m n√∫t m·ªõi
        buttons.push(buttonData);
      }

      renderButtons();
      closePopup();
      tg.HapticFeedback.impactOccurred('light');
    }

    function deleteButton() {
      if (editingIndex >= 0) {
        buttons.splice(editingIndex, 1);
        renderButtons();
        closePopup();
        tg.HapticFeedback.impactOccurred('medium');
      }
    }

    function renderButtons() {
      buttonCount.textContent = buttons.length;
      
      if (buttons.length === 0) {
        emptyState.style.display = "block";
        return;
      }

      emptyState.style.display = "none";
      
      buttonsList.innerHTML = buttons.map((btn, index) => `
        <div class="button-item">
          <div class="button-info">
            <div class="button-label">${escapeHtml(btn.title)}</div>
            <div class="button-url">${escapeHtml(btn.link)}</div>
          </div>
          <div class="button-actions">
            <button class="btn btn-edit" onclick="openPopup(${index})">‚úèÔ∏è</button>
            <button class="btn btn-delete" onclick="deleteButtonAt(${index})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function deleteButtonAt(index) {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a n√∫t n√†y?')) {
        buttons.splice(index, 1);
        renderButtons();
        tg.HapticFeedback.impactOccurred('medium');
      }
    }

    function sendToBot() {
      if (buttons.length === 0) {
        alert("Vui l√≤ng th√™m √≠t nh·∫•t 1 n√∫t");
        return;
      }

      // G·ª≠i d·ªØ li·ªáu v·ªÅ bot Telegram
      try {
        tg.sendData(JSON.stringify(buttons));
        tg.close();
      } catch (error) {
        console.error('L·ªói khi g·ª≠i d·ªØ li·ªáu:', error);
        alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i d·ªØ li·ªáu v·ªÅ bot');
      }
    }

    function isValidUrl(string) {
      try {
        new URL(string);
        return string.startsWith('http://') || string.startsWith('https://');
      } catch (_) {
        return false;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Kh·ªüi t·∫°o
    renderButtons();

    // Hi·ªÉn th·ªã n√∫t main c·ªßa Telegram
    tg.MainButton.setText("‚úÖ Ho√†n t·∫•t");
    tg.MainButton.onClick(() => sendToBot());
    
    // C·∫≠p nh·∫≠t main button khi c√≥ thay ƒë·ªïi
    const updateMainButton = () => {
      if (buttons.length > 0) {
        tg.MainButton.setText(`‚úÖ Ho√†n t·∫•t (${buttons.length})`);
        tg.MainButton.show();
      } else {
        tg.MainButton.hide();
      }
    };

    // Override renderButtons ƒë·ªÉ c·∫≠p nh·∫≠t main button
    const originalRenderButtons = renderButtons;
    renderButtons = function() {
      originalRenderButtons();
      updateMainButton();
    };

    updateMainButton();
  </script>
</body>
</html>
